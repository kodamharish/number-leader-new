{% include './company_profile.html' %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products and Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
           
            position: relative;
        }

        .container {
            margin-left: 240px;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        .small-plus-button {
            font-size: 2rem;
            color: black;
            text-align: center;
            cursor: pointer;
            display: block;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .entry-form {
            margin-top: 20px;
            display: none;
        }

        .product-list {
            margin-top: 20px;
        }

        .product-card {
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            font-family: 'Arial MT Rounded';
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .form-container {
            display: flex;
            flex: 1;
        }

        .form-column {
            flex: 1;
            margin-right: 20px;
            display: flex;
            flex-direction: column;
        }

        .form-column:last-child {
            margin-right: 0;
        }

        .form-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            color: grey;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .form-control {
            border: none;
            border-bottom: 1px solid grey;
            border-radius: 0;
            width: 100%;
            padding: 10px;
            margin-bottom: 0.5rem;
            background-color: transparent;
            transition: background-color 0s;
            font-size: 16px;
            margin-top: 2px;
        }

        .form-control:focus {
            box-shadow: none;
            outline: none;
        }

        .form-control[readonly] {
            border: none;
        }

        .card-buttons {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-left: 20px;
        }

        .delete-button, .edit-button {
            margin-bottom: 5px;
        }

        .submit-button {
            position: relative;
            display: block;
            margin-top: 20px;
            margin-left: auto;
        }

        .divider {
            border-top: 1px solid grey;
            margin: 10px 0;
        }

        .inline-inputs {
            display: flex;
            align-items: center;
        }

        .inline-inputs label {
            margin-right: 5px;
        }

        .inline-inputs input {
            width: 150px;
            margin-right: 5px;
        }

        .d-flex {
            display: flex;
            align-items: center;
        }

        .editable .form-control {
            border-bottom: 1px solid grey;
            background-color: white !important;
        }

        /* Custom Styles for Display Mode */
        .display-mode .form-control {
            border: none;
            background-color: transparent;
            font-size: 16px; /* Example font size */
            color: #333; /* Example font color */
        }

        .display-mode .form-group label {
            font-size: 12px; /* Example label font size */
            font-weight: normal; /* Example label font weight */
        }

        .display-mode .form-control {
            margin-top: -20px;
            margin-left: 0px;
            padding-left: 0px;
        }

        .display-mode .card-buttons {
            position: static;
            margin-left: 0;
        }

        /* Inline Editing Styles */
        .editing .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .editing .form-group label {
            margin-bottom: 5px;
            color: grey;
            font-size: 14px;
        }

        .editing .form-control {
            border-bottom: 1px solid grey;
            background-color: white;
            font-size: 16px;
        }

        .editing .form-column {
            flex: 1;
            margin-right: 20px;
        }

        .editing .form-column:last-child {
            margin-right: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="small-plus-button" onclick="toggleForm()">+</div>

        <div id="entryForm" class="entry-form">
            <div class="form-container">
                <div class="form-column">
                    <div class="form-group">
                        <label for="productTitle">Product Title</label>
                        <input type="text" class="form-control" id="productTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="industry">Industry / Sector</label>
                        <input type="text" class="form-control" id="industry" required>
                    </div>
                    <div class="form-group">
                        <label for="businessType">Type of Business</label>
                        <input type="text" class="form-control" id="businessType" required>
                    </div>
                    <div class="form-group">
                        <label for="problemsSolved">Problems Solved</label>
                        <input type="text" class="form-control" id="problemsSolved" required>
                    </div>
                </div>
                <div class="form-column">
                    <div class="form-group">
                        <label for="launchDate">Launch Date</label>
                        <input type="date" class="form-control" id="launchDate" required>
                    </div>
                    <div class="form-group">
                        <label>Three Year Revenue & Profit</label>
                        <div class="inline-inputs">
                            <label>Current Year (YTD):</label>
                        </div>
                        <div class="inline-inputs">
                            <label>Revenue= </label>
                            <input type="text" class="form-control" id="revenueCurrentYear" required>
                            <label>P/L =</label>
                            <input type="text" class="form-control" id="profitCurrentYear" required>
                        </div>
                        <div class="inline-inputs">
                            <label>Previous Year:</label>
                        </div>
                        <div class="inline-inputs">
                            <label>Revenue= </label>
                            <input type="text" class="form-control" id="revenuePreviousYear" required>
                            <label>P/L=</label>
                            <input type="text" class="form-control" id="profitPreviousYear" required>
                        </div>
                        <div class="inline-inputs">
                            <label>A year before:</label>
                        </div>
                        <div class="inline-inputs">
                            <label>Revenue= </label>
                            <input type="text" class="form-control" id="revenueYearBefore" required>
                            <label>P/L=</label>
                            <input type="text" class="form-control" id="profitYearBefore" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customers">Customers</label>
                        <input type="text" class="form-control" id="customers" required>
                    </div>
                    <div class="form-group">
                        <label for="competitors">Competitors</label>
                        <input type="text" class="form-control" id="competitors" required>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-primary submit-button" onclick="saveProduct()">Add Product</button>
        </div>

        <div id="productList" class="product-list"></div>
    </div>

<script>
    let products = [];
let editIndex = -1;

// Fetch and display products from the server when the page loads
async function fetchProducts() {
    try {
        const response = await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }

        const data = await response.json();
        products = data.products; // Assuming the server returns a list of products
        displayProducts();
    } catch (error) {
        console.error('Error fetching products:', error);
        alert('An error occurred while fetching products.');
    }
}

// Function to display products in the list
function displayProducts() {
    const productList = document.getElementById('productList');
    productList.innerHTML = '';

    products.forEach((product, index) => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card display-mode';
        productCard.innerHTML = `
            <div class="form-container">
                <div class="form-column">
                    <div class="form-group">
                        <label>Product Title</label>
                        <div class="form-control">${product.productTitle}</div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <div class="form-control">${product.description}</div>
                    </div>
                    <div class="form-group">
                        <label>Industry / Sector</label>
                        <div class="form-control">${product.industry}</div>
                    </div>
                    <div class="form-group">
                        <label>Type of Business</label>
                        <div class="form-control">${product.businessType}</div>
                    </div>
                    <div class="form-group">
                        <label>Problems Solved</label>
                        <div class="form-control">${product.problemsSolved}</div>
                    </div>
                </div>
                <div class="form-column">
                    <div class="form-group">
                        <label>Launch Date</label>
                        <div class="form-control">${product.launchDate}</div>
                    </div>
                    <div class="form-group">
                        <label>Three Year Revenue & Profit</label>
                        <div class="form-control">Current Year Revenue: ${product.revenueCurrentYear}, Profit: ${product.profitCurrentYear}</div>
                        <div class="form-control">Previous Year Revenue: ${product.revenuePreviousYear}, Profit: ${product.profitPreviousYear}</div>
                        <div class="form-control">A Year Before Revenue: ${product.revenueYearBefore}, Profit: ${product.profitYearBefore}</div>
                    </div>
                    <div class="form-group">
                        <label>Customers</label>
                        <div class="form-control">${product.customers}</div>
                    </div>
                    <div class="form-group">
                        <label>Competitors</label>
                        <div class="form-control">${product.competitors}</div>
                    </div>
                </div>
            </div>
            <div class="card-buttons">
                <button class="btn btn-secondary edit-button" onclick="editProduct(${index})">Edit</button>
                <button class="btn btn-danger delete-button" onclick="deleteProduct(${index})">Delete</button>
            </div>
        `;
        productList.appendChild(productCard);
    });
}

// Save new or edited product
async function saveProduct1() {
    const productTitle = document.getElementById('productTitle').value;
    const description = document.getElementById('description').value;
    const industry = document.getElementById('industry').value;
    const businessType = document.getElementById('businessType').value;
    const problemsSolved = document.getElementById('problemsSolved').value;
    const launchDate = document.getElementById('launchDate').value;
    const revenueCurrentYear = document.getElementById('revenueCurrentYear').value;
    const profitCurrentYear = document.getElementById('profitCurrentYear').value;
    const revenuePreviousYear = document.getElementById('revenuePreviousYear').value;
    const profitPreviousYear = document.getElementById('profitPreviousYear').value;
    const revenueYearBefore = document.getElementById('revenueYearBefore').value;
    const profitYearBefore = document.getElementById('profitYearBefore').value;
    const customers = document.getElementById('customers').value;
    const competitors = document.getElementById('competitors').value;

    const product = {
        productTitle,
        description,
        industry,
        businessType,
        problemsSolved,
        launchDate,
        revenueCurrentYear,
        profitCurrentYear,
        revenuePreviousYear,
        profitPreviousYear,
        revenueYearBefore,
        profitYearBefore,
        customers,
        competitors
    };

    const method = editIndex >= 0 ? 'PUT' : 'POST';
    const url = "{% url 'pitch_and_product' company.company_id %}";

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ ...product, id: editIndex >= 0 ? products[editIndex].id : null })
        });

        if (!response.ok) {
            throw new Error('Error saving product');
        }

        const data = await response.json();

        if (method === 'POST') {
            products.unshift({ ...product, id: data.id }); // Add new product to the top
        } else {
            products[editIndex] = product; // Update existing product
        }

        displayProducts();
        toggleForm();
        editIndex = -1;
    } catch (error) {
        console.error('Error saving product:', error);
        alert('An error occurred while saving the product.');
    }
}


async function saveProduct() {
    const productTitle = document.getElementById('productTitle').value;
    const description = document.getElementById('description').value;
    const industry = document.getElementById('industry').value;
    const businessType = document.getElementById('businessType').value;
    const problemsSolved = document.getElementById('problemsSolved').value;
    const launchDate = document.getElementById('launchDate').value;
    const revenueCurrentYear = document.getElementById('revenueCurrentYear').value;
    const profitCurrentYear = document.getElementById('profitCurrentYear').value;
    const revenuePreviousYear = document.getElementById('revenuePreviousYear').value;
    const profitPreviousYear = document.getElementById('profitPreviousYear').value;
    const revenueYearBefore = document.getElementById('revenueYearBefore').value;
    const profitYearBefore = document.getElementById('profitYearBefore').value;
    const customers = document.getElementById('customers').value;
    const competitors = document.getElementById('competitors').value;

    const product = {
        productTitle,
        description,
        industry,
        businessType,
        problemsSolved,
        launchDate,
        revenueCurrentYear,
        profitCurrentYear,
        revenuePreviousYear,
        profitPreviousYear,
        revenueYearBefore,
        profitYearBefore,
        customers,
        competitors
    };

    const method = editIndex >= 0 ? 'PUT' : 'POST';
    const url = "{% url 'pitch_and_product' company.company_id %}";

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ ...product, id: editIndex >= 0 ? products[editIndex].id : null }) // Keep the existing ID during PUT
        });

        const data = await response.json();

        if (method === 'POST') {
            products.unshift({ ...product, id: data.id }); // Ensure new product gets an ID
        } else {
            products[editIndex] = { ...product, id: products[editIndex].id }; // Keep the same ID after editing
        }

        displayProducts();
        toggleForm();
        editIndex = -1;
    } catch (error) {
        console.error('Error saving product:', error);
        alert('An error occurred while saving the product.');
    }
}

// Edit product
function editProduct1(index) {
    editIndex = index;
    const product = products[index];

    document.getElementById('productTitle').value = product.productTitle;
    document.getElementById('description').value = product.description;
    document.getElementById('industry').value = product.industry;
    document.getElementById('businessType').value = product.businessType;
    document.getElementById('problemsSolved').value = product.problemsSolved;
    document.getElementById('launchDate').value = product.launchDate;
    document.getElementById('revenueCurrentYear').value = product.revenueCurrentYear;
    document.getElementById('profitCurrentYear').value = product.profitCurrentYear;
    document.getElementById('revenuePreviousYear').value = product.revenuePreviousYear;
    document.getElementById('profitPreviousYear').value = product.profitPreviousYear;
    document.getElementById('revenueYearBefore').value = product.revenueYearBefore;
    document.getElementById('profitYearBefore').value = product.profitYearBefore;
    document.getElementById('customers').value = product.customers;
    document.getElementById('competitors').value = product.competitors;

    toggleForm();
    document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('editing');
    });
    document.querySelector(`.product-card:nth-child(${index + 1})`).classList.add('editing');
}



function editProduct(index) {
    // Set the edit index so we know we are in edit mode
    editIndex = index;
    const product = products[index];

    // Populate the form fields with the product data
    document.getElementById('productTitle').value = product.productTitle;
    document.getElementById('description').value = product.description;
    document.getElementById('industry').value = product.industry;
    document.getElementById('businessType').value = product.businessType;
    document.getElementById('problemsSolved').value = product.problemsSolved;
    document.getElementById('launchDate').value = product.launchDate;
    document.getElementById('revenueCurrentYear').value = product.revenueCurrentYear;
    document.getElementById('profitCurrentYear').value = product.profitCurrentYear;
    document.getElementById('revenuePreviousYear').value = product.revenuePreviousYear;
    document.getElementById('profitPreviousYear').value = product.profitPreviousYear;
    document.getElementById('revenueYearBefore').value = product.revenueYearBefore;
    document.getElementById('profitYearBefore').value = product.profitYearBefore;
    document.getElementById('customers').value = product.customers;
    document.getElementById('competitors').value = product.competitors;

    // Ensure the form is visible and not duplicated
    const entryForm = document.getElementById('entryForm');
    entryForm.style.display = 'block';  // Show the form if it's hidden
    window.scrollTo(0, entryForm.offsetTop);  // Scroll to the form if needed

    // Ensure no other form is rendered
    document.querySelectorAll('.product-card').forEach(card => {
        card.classList.remove('editing');
    });

    // Add an 'editing' class to the product card being edited (optional)
    document.querySelector(`.product-card:nth-child(${index + 1})`).classList.add('editing');
}



// Delete product
async function deleteProduct2(index) {
    const product = products[index];

    try {
        const response = await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ id: product.id })
        });

        if (!response.ok) {
            throw new Error('Error deleting product');
        }

        products.splice(index, 1);
        displayProducts();
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('An error occurred while deleting the product.');
    }
}


async function deleteProduct1(index) {
    const product = products[index];

    try {
        const response = await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ id: product.id })
        });

        products.splice(index, 1);
        displayProducts();

    } catch (error) {
        console.error('Error deleting product:', error);
        alert('An error occurred while deleting the product. Please try again.');
    }
}


async function deleteProduct3(index) {
    const product = products[index];

    try {
        // Send delete request
        await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ id: product.id })
        });

        // Remove product from local array and update the UI
        products.splice(index, 1);
        displayProducts();
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('An error occurred while deleting the product.');
    }
}


async function deleteProduct4(index) {
    const product = products[index];

    // Immediately remove product from UI
    products.splice(index, 1);
    displayProducts();

    try {
        // Send DELETE request to the server
        await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ id: product.id })
        });

        // Optionally log success or remove this block since the UI is already updated
        console.log(`Product with ID ${product.id} deleted from database.`);
    } catch (error) {
        console.error('Error deleting product from the database:', error);
        alert('An error occurred while deleting the product from the database.');
        // Revert the UI change if the delete request fails
        products.splice(index, 0, product);  // Reinsert the deleted product back into the array
        displayProducts();  // Re-render the UI to show the reverted product
    }
}




async function deleteProduct(index) {
    const product = products[index];

    if (!product.id) {
        console.error('Product ID is undefined');
        return;
    }

    // Immediately remove product from UI
    products.splice(index, 1);
    displayProducts();

    try {
        // Send DELETE request to the server
        await fetch("{% url 'pitch_and_product' company.company_id %}", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({ id: product.id })
        });

        console.log(`Product with ID ${product.id} deleted from database.`);
    } catch (error) {
        console.error('Error deleting product from the database:', error);
        alert('An error occurred while deleting the product from the database.');
        // Revert the UI change if the delete request fails
        products.splice(index, 0, product);  // Reinsert the deleted product back into the array
        displayProducts();  // Re-render the UI to show the reverted product
    }
}

// Toggle form visibility
function toggleForm() {
    const entryForm = document.getElementById('entryForm');
    entryForm.style.display = (entryForm.style.display === 'none' || entryForm.style.display === '') ? 'block' : 'none';
}

// Initialize the page
//fetchProducts(); // Load products when the page is loaded

 // Initialize the page
 displayProducts();
 if (products.length === 0) {
     document.getElementById('entryForm').style.display = 'block';
 }

</script>
        
</body>
</html>
